name: Time Trigger Task
on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘ï¼Œæ–¹ä¾¿æµ‹è¯•
jobs:
  run_tasks:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      # é…ç½® uv ç¼“å­˜ç›®å½•ï¼Œæ–¹ä¾¿ cache action æ•è·
      UV_CACHE_DIR: /tmp/.uv-cache
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      # 1. å®‰è£… Rust
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      # 2. ç¼“å­˜ Rust (Cargo) ä¾èµ–
      # ä½¿ç”¨å®˜æ–¹æ¨èçš„ Swatinem/rust-cacheï¼Œå®ƒéå¸¸æ™ºèƒ½ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½® key
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          # ç¼“å­˜ key é»˜è®¤åŸºäº Cargo.lockï¼Œå¦‚æœæ”¹äº† rust ä»£ç ä¹Ÿä¼šæ™ºèƒ½å¤„ç†
          workspaces: "."
      # 3. å®‰è£… uv å¹¶å¼€å¯è‡ªå¸¦ç¼“å­˜åŠŸèƒ½
      # setup-uv@v5 è‡ªå¸¦ enable-cache é€‰é¡¹ï¼Œéå¸¸æ–¹ä¾¿
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock" # æˆ–è€… pyproject.toml
      # 4. è®¾ç½® Python
      - name: Set up Python
        run: uv python install
      # 5. æ„å»ºä¸è¿è¡Œ
      - name: Build and Run
        env:
          DEVICE_KEYS: ${{ secrets.DEVICE_KEYS }}
        run: |
          # A. åŒæ­¥ä¾èµ– (åˆ©ç”¨ uv ç¼“å­˜)
          # ç¡®ä¿ maturin åœ¨ pyproject.toml çš„ dev ä¾èµ–ä¸­
          uv sync --frozen 
          # B. ç¼–è¯‘ Rust æ‰©å±• (åˆ©ç”¨ rust-cache)
          # æ³¨æ„ï¼šä¸è¦ç”¨ uv tool install maturinï¼Œç›´æ¥ç”¨ venv é‡Œçš„
          uv run maturin develop --release
          # C. è¿è¡Œè„šæœ¬
          uv run python/time_trigger_task/__init__.py
      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ¤– Auto: Update task status [skip ci]"
          file_pattern: "configs/*.json"
